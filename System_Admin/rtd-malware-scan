#!/bin/bash
PUBLICATION="RuntimeData Virus Scan Tool for Ubuntu"
VERSION="1.10"
#
#::             			A D M I N   C O M M A N D L E T   
#::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
#::::::::::::::::::::::::::::::::::::::// Simple Admin Tool //::::::::::::::::::::::::::::::::::::::::// Linux //::::::::
#::
#:: Author:   	SLS
#:: Version 	1.00
#::
#::	January 1 2019  - SLS
#::		* File originally created.
#::
#::
#::	Purpose: The purpose of this script is to make is simpler to scan a folder directly from cli. 
#:: 	 	 'clamscan' has way too many option to rememer and this commandlet will use the poper option 
#::		 for you and quarantine infected files to a folder. 
#::
#::
#::
#::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
#::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
#
#
#
# This  script was originally developed for RuntimeData, a small OEM in Buffalo Center, IA.
# This OEM and store nolonger exists as its owner has passed away.
# This script is shared in the hopes that someone will find it useful.
#
# This script is intended to live in the ~/bin/ or /bin/ folder, alternatively in the $PATH.

###########################################################################
##                                                                       ##
##                       Set Environment                                 ##
##                                                                       ##
###########################################################################
#


# Set colors for prompting on screen.
	YELLOW="\033[1;33m"
	RED="\033[0;31m"
	ENDCOLOR="\033[0m"
	GREEN="\033[0;32m"
	BLUE="\033[0;34m"

# Display startup message
echo -e $YELLOW"$PUBLICATION $VERSION" $ENDCOLOR

# Set the location of the quarantined files
QUARANINE=./VIRUS
if [ ! -d "$QUARANINE" ]; then
	mkdir "$QUARANINE"
fi

# set the location of the log file
CLAMSCANLOGFILE=~/clamscan.log

SCANDIR=$@

###########################################################################
##                                                                       ##
##                            Check prereq                               ##
##                                                                       ##
###########################################################################
#
# Check it the program is installed and otherwise install it...

# First discover what menu system is installed. Some systems use "dialog" and
# other systems use whiptail for the terminal to show menus and dialogs. 
if hash whiptail >/dev/null ; then
	export rtd_menu=whiptail
elif hash dialog >/dev/null ; then
	export rtd_menu=dialog
else
	echo "There is no menu dialog installed on this system..."
	read -p Press [ENTER] to exit... 
	exit 1
fi

# If the RTD functions file is present use it, otherwise download a new copy of it and use this. 
if [ -f ~/bin/_rtd_functions ]; then 
	source ~/bin/_rtd_functions
else 
	if [ -f /opt/rtd/scripts/_rtd_functions ]; then 
		source /opt/rtd/scripts/_rtd_functions
	else 
		if ( $rtd_menu  --title "RTD Nordvpn Starter: Get Parts" --yesno "For this tool to run correctly I need to download some software from the internet. Is this OK?" 8 78); then
			echo "OK Thank you. Geting the required scrpt lirary file "RTD_FUNCTIONS"" 
			sudo mkdir -p /opt/rtd/scripts
			sudo wget -q https://github.com/vonschutter/RTD-Build/raw/master/System_Setup/_rtd_functions -P /opt/rtd/scripts/
			source /opt/rtd/scripts/_rtd_functions
		else
			echo "You selected No, exit status was $?."
			exit
		fi
	fi
fi


echo "RTDFUNCTIONS = $RTDFUNCTIONS"
if [ $RTDFUNCTIONS -eq 1 ]; then
        echo RTD functions confirmed loaded!
      else
        echo RTD functions NOT loaded!
	echo Please make sure that you are connected to the internet and that sudo and wget are installed.
	exit 1
fi





runifthere() {
    if hash clamscan 2>/dev/null; then
	#Check and see if Quarantene zone is there and scan home. 
	if [ -d "$QUARANINE" ]; then
	  clamscan $SCANDIR -r -a -i -l $CLAMSCANLOGFILE --bytecode=yes --stdout  --phishing-sigs --bell --algorithmic-detection=yes --move="$QUARANINE" 
	else
	  echo "$QUARANINE" not found! Is this folder writable?
	fi
	 
    else
        echo "You seem to have no clamav... I will try to get it... "
        echo "I will need to become admin to do that..."
        sudo apt install clamav
            if [ $? != 0 ];
            then
                echo "That install didn't work out so well."
                echo "Please manually try to add the software since I couldn't do it."
                exit
            fi
        echo "OK kindly try again!"
    fi
}





###########################################################################
##                                                                       ##
##                            Execute                                    ##
##                                                                       ##
###########################################################################
#
# Display sumary
echo " "
echo ___________________________________________________
echo " "
echo "[   Setting    ] [           Value             ]"
echo " Logging to:         $CLAMSCANLOGFILE"
echo " Quarantine in:      $QUARANINE"
echo " "
echo ___________________________________________________
echo " "
echo " Starting scan...."
echo " Scanning folder: $@"

# Run the scan function
runifthere



